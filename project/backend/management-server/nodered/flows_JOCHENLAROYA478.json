[{"id":"5c84935c.97f78c","type":"tab","label":"subscriptions","disabled":true,"info":""},{"id":"8d375144.8b6bc","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"b6e7dafc.c46898","type":"mqtt-broker","z":"","name":"mosquitto","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"dd2f5496.bd68f8","type":"mqtt-broker","z":"","name":"mosquitto","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"8c2c482d.c4ae48","type":"mqtt-broker","z":"","name":"mosquitto","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"588ab8f8.87bb48","type":"mqtt-broker","z":"","name":"mosquitto","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"b529c024.9e935","type":"mqtt-broker","z":"","name":"mosquitto","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"1a7c075d.2f6a49","type":"websocket-listener","z":"","path":"/ws/data","wholemsg":"false"},{"id":"c5abe9ca.842268","type":"http in","z":"5c84935c.97f78c","name":"","url":"/data","method":"put","upload":false,"swaggerDoc":"","x":90,"y":40,"wires":[["38eeed56.42b5f2"]]},{"id":"38eeed56.42b5f2","type":"function","z":"5c84935c.97f78c","name":"specifySubs","func":"let sub = global.get(\"subscriptions\") || {};\nfor(let key in msg.payload){\n    console.log(key);\n    if(msg.payload[key] == true)\n        sub[key] = true;\n    else sub[key] = false;\n    \n}\nglobal.set(\"subscriptions\", sub);\n\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":40,"wires":[["8f47a3b0.2f7f5"]]},{"id":"eaf65e2f.7b51d","type":"http response","z":"5c84935c.97f78c","name":"","statusCode":"200","headers":{},"x":760,"y":80,"wires":[]},{"id":"b93d74d6.921fb8","type":"function","z":"5c84935c.97f78c","name":"setAllSubs","func":"let sub = global.get(\"subscriptions\") || {};\nsub.acceleration = true;\nsub.speed = true;\nsub.orientation = true;\nsub.position = true;\nsub.battery = true;\nglobal.set(\"subscriptions\", sub);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":310,"y":120,"wires":[["8f47a3b0.2f7f5"]]},{"id":"988e2b96.f1c318","type":"http in","z":"5c84935c.97f78c","name":"","url":"/data/all","method":"put","upload":false,"swaggerDoc":"","x":100,"y":120,"wires":[["b93d74d6.921fb8"]]},{"id":"b0a5a322.7d339","type":"http in","z":"5c84935c.97f78c","name":"","url":"/data/none","method":"put","upload":false,"swaggerDoc":"","x":110,"y":160,"wires":[["e83d4f80.4568c"]]},{"id":"e83d4f80.4568c","type":"function","z":"5c84935c.97f78c","name":"clearSubs","func":"global.set(\"subscriptions\", {});\n\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":160,"wires":[["8f47a3b0.2f7f5"]]},{"id":"8f47a3b0.2f7f5","type":"function","z":"5c84935c.97f78c","name":"generatePayload","func":"let sub = global.get(\"subscriptions\") || {};\n\nfor(let key of Object.keys(sub)){\n    msg.payload[key] = sub[key];\n}\n//msg.payload = global.get(\"drone/\" + msg.req.query);\nmsg.subs = global.subscriptions;\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":80,"wires":[["eaf65e2f.7b51d","a892e378.c4e7d"]]},{"id":"9be3f7f9.966c98","type":"debug","z":"5c84935c.97f78c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":970,"y":40,"wires":[]},{"id":"a892e378.c4e7d","type":"change","z":"5c84935c.97f78c","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"subscriptions","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":780,"y":40,"wires":[["9be3f7f9.966c98"]]},{"id":"7bbe8092.235c8","type":"http in","z":"5c84935c.97f78c","name":"","url":"/data","method":"get","upload":false,"swaggerDoc":"","x":90,"y":80,"wires":[["8f47a3b0.2f7f5"]]},{"id":"76786c22.b746d4","type":"http response","z":"5c84935c.97f78c","name":"","statusCode":"200","headers":{},"x":520,"y":340,"wires":[]},{"id":"a9887ab4.5408a8","type":"http in","z":"5c84935c.97f78c","name":"","url":"/path/set","method":"post","upload":false,"swaggerDoc":"","x":110,"y":340,"wires":[["4baa9d76.3171f4"]]},{"id":"3f9a71c1.94768e","type":"http in","z":"5c84935c.97f78c","name":"","url":"drone/start","method":"post","upload":false,"swaggerDoc":"","x":120,"y":440,"wires":[["2b473fc.ecb10c"]]},{"id":"6485321.adde4cc","type":"http in","z":"5c84935c.97f78c","name":"","url":"drone/pause","method":"post","upload":false,"swaggerDoc":"","x":120,"y":600,"wires":[["f90bed81.ba9b2"]]},{"id":"f90bed81.ba9b2","type":"function","z":"5c84935c.97f78c","name":"set statusinfo","func":"global.set('flying', false);\n\nglobal.set('statusinfo', {\"validated\": true, \"sent\": true, \"flying\": false});\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":600,"wires":[["23a374cb.195e3c","d2b71f4e.73907"]]},{"id":"2b473fc.ecb10c","type":"switch","z":"5c84935c.97f78c","name":"destination is null?","property":"destination","propertyType":"global","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":350,"y":440,"wires":[["56377288.bd23fc"],["108aa5d7.5a023a"]]},{"id":"108aa5d7.5a023a","type":"http response","z":"5c84935c.97f78c","name":"","statusCode":"500","headers":{},"x":540,"y":460,"wires":[]},{"id":"56377288.bd23fc","type":"function","z":"5c84935c.97f78c","name":"send dest + statusinfo","func":"global.set('statusinfo', {\"validated\": true, \"sent\": true, \"flying\": true});\nglobal.set('flying', true);\n\nmsg.payload = global.get('destination');\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":420,"wires":[["3b9ad945.d294e6","1e7fb391.37389c"]]},{"id":"23a374cb.195e3c","type":"http response","z":"5c84935c.97f78c","name":"","statusCode":"200","headers":{},"x":500,"y":580,"wires":[]},{"id":"d2b71f4e.73907","type":"mqtt out","z":"5c84935c.97f78c","name":"","topic":"drone/pause","qos":"1","retain":"","broker":"b6e7dafc.c46898","x":510,"y":620,"wires":[]},{"id":"4baa9d76.3171f4","type":"function","z":"5c84935c.97f78c","name":"stel beginparams in","func":"var moveteller = 1;\n\n\nglobal.set('waypoints',msg.payload);\nmsg.payload = global.get('waypoints').waypoints[moveteller++];\nglobal.set('mapid', global.get('waypoints').mapId);\nglobal.set(\"destination\", msg.payload);\nglobal.set('moveteller', moveteller);\n//reset want nieuwe coo om naartoe te gaan\nglobal.set('stop',false);\nglobal.set('scanning', false);\nglobal.set('arrived', false);\n\n\nglobal.set('flying', false)\n\nglobal.set('statusinfo', {\"validated\": true, \"sent\": true, \"flying\": false});\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":340,"wires":[["76786c22.b746d4"]],"info":"Nadat het pad getekend en gevalideerd is, gaan de beginparameters ingesteld \nworden zodat alles klaar is voor de vlucht.\n\n - moveteller [global]: wordt gebruikt om de verschillende waypoints te overlopen -\n    word op 1 gezet omdat het eerste waypoint zijn startlocatie is\n - waypoints [global]: de payload bevat de verschillende waypoints van het getekende pad\n - destination [global]: de destination wordt gezet op het eerst volgende waypoint,\n    daarna wordt de moveteller ge√Øncrementeert en terug geset\n - stop [global]: geeft aan of de drone al zijn waypoints heeft afgelopen of niet\n - scanning [global]: geeft aan of de drone op een waypoint zit dat nodig is om te scannen\n - arrived [global]: geeft aan of de drone op zijn waypoint is toegekomen\n - flying [global]: geeft aan of de drone aan het vliegen is\n - statusinfo [global]: geeft de status van de drone aan, in dit geval is het\n    pad al getekend en doorgestuurd naar de drone maar de drone is nog niet gestart"},{"id":"3b9ad945.d294e6","type":"mqtt out","z":"5c84935c.97f78c","name":"","topic":"drone/start","qos":"1","retain":"","broker":"b6e7dafc.c46898","x":790,"y":440,"wires":[]},{"id":"f48af709.808b58","type":"http in","z":"5c84935c.97f78c","name":"","url":"/statusinfo","method":"get","upload":false,"swaggerDoc":"","x":110,"y":920,"wires":[["a65b58b.e1932a8"]]},{"id":"a65b58b.e1932a8","type":"function","z":"5c84935c.97f78c","name":"get info","func":"msg.payload = global.get('statusinfo') || {\"validated\": false, \"sent\": false, \"flying\": false};\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":920,"wires":[["200601be.b2728e"]]},{"id":"200601be.b2728e","type":"http response","z":"5c84935c.97f78c","name":"","statusCode":"200","headers":{},"x":460,"y":920,"wires":[]},{"id":"77b4e2bc.36d27c","type":"http request","z":"5c84935c.97f78c","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"http://localhost:3000/api/flightpath","tls":"","proxy":"","authType":"basic","x":330,"y":240,"wires":[["398ed3a3.5bab9c"]]},{"id":"bcc09bd7.27e588","type":"http in","z":"5c84935c.97f78c","name":"","url":"/path/validate","method":"post","upload":false,"swaggerDoc":"","x":120,"y":240,"wires":[["77b4e2bc.36d27c"]]},{"id":"5404a13f.8d76e","type":"function","z":"5c84935c.97f78c","name":"set statusinfo validated true","func":"global.set('statusinfo', {\"validated\": true, \"sent\": false, \"flying\": false});\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":220,"wires":[["a95d28ef.d7a128"]]},{"id":"398ed3a3.5bab9c","type":"switch","z":"5c84935c.97f78c","name":"Validating succeeded?","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"neq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":540,"y":240,"wires":[["5404a13f.8d76e"],["e713eb15.4c4a98"]]},{"id":"e713eb15.4c4a98","type":"function","z":"5c84935c.97f78c","name":"set statusinfo validated false","func":"global.set('statusinfo', {\"validated\": false, \"sent\": false, \"flying\": false});\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":260,"wires":[["7f082c63.0e88f4"]]},{"id":"a95d28ef.d7a128","type":"http response","z":"5c84935c.97f78c","name":"","statusCode":"200","headers":{},"x":1020,"y":220,"wires":[]},{"id":"7f082c63.0e88f4","type":"http response","z":"5c84935c.97f78c","name":"","statusCode":"500","headers":{},"x":1020,"y":260,"wires":[]},{"id":"1e7fb391.37389c","type":"http response","z":"5c84935c.97f78c","name":"","statusCode":"200","headers":{},"x":780,"y":400,"wires":[]},{"id":"73ad9e26.40b53","type":"http in","z":"5c84935c.97f78c","name":"","url":"drone/stop","method":"post","upload":false,"swaggerDoc":"","x":120,"y":720,"wires":[["8eedd5c6.f0af28"]]},{"id":"8eedd5c6.f0af28","type":"function","z":"5c84935c.97f78c","name":"set statusinfo","func":"global.set('flying', false);\n\nglobal.set('statusinfo', {\"validated\": false, \"sent\": false, \"flying\": false});\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":720,"wires":[["eafbe82f.8cbea8","f82d5738.7e8468"]]},{"id":"eafbe82f.8cbea8","type":"http response","z":"5c84935c.97f78c","name":"","statusCode":"200","headers":{},"x":500,"y":700,"wires":[]},{"id":"f82d5738.7e8468","type":"mqtt out","z":"5c84935c.97f78c","name":"","topic":"drone/stop","qos":"1","retain":"","broker":"b6e7dafc.c46898","x":510,"y":740,"wires":[]},{"id":"ddbb899e.fcc428","type":"mqtt in","z":"5c84935c.97f78c","name":"","topic":"drone/start","qos":"1","datatype":"auto","broker":"b6e7dafc.c46898","x":80,"y":520,"wires":[["5b8f0cfc.d7f234"]]},{"id":"5b8f0cfc.d7f234","type":"mqtt out","z":"5c84935c.97f78c","name":"","topic":"drone/moveto","qos":"1","retain":"","broker":"b6e7dafc.c46898","x":270,"y":520,"wires":[]},{"id":"eec4312.a21ead","type":"http in","z":"5c84935c.97f78c","name":"","url":"drone/homebase","method":"post","upload":false,"swaggerDoc":"","x":140,"y":840,"wires":[["5cd6f16a.71103","360de33a.3ab24c"]]},{"id":"5cd6f16a.71103","type":"mqtt out","z":"5c84935c.97f78c","name":"","topic":"drone/homebase","qos":"","retain":"","broker":"dd2f5496.bd68f8","x":390,"y":820,"wires":[]},{"id":"360de33a.3ab24c","type":"http response","z":"5c84935c.97f78c","name":"","statusCode":"200","headers":{},"x":360,"y":860,"wires":[]},{"id":"59f8eafa.2cc664","type":"mqtt in","z":"5c84935c.97f78c","name":"","topic":"drone/battery","qos":"1","datatype":"json","broker":"8c2c482d.c4ae48","x":90,"y":1020,"wires":[["6ec83642.87cdc8"]]},{"id":"bcb495.e3c31b68","type":"mqtt in","z":"5c84935c.97f78c","name":"","topic":"drone/position","qos":"2","datatype":"json","broker":"8c2c482d.c4ae48","x":90,"y":1080,"wires":[["6ec83642.87cdc8"]]},{"id":"bbfd37c5.b68cd8","type":"mqtt in","z":"5c84935c.97f78c","name":"","topic":"drone/acceleration","qos":"1","datatype":"json","broker":"8c2c482d.c4ae48","x":110,"y":1140,"wires":[["6ec83642.87cdc8"]]},{"id":"2acdb523.ee0a3a","type":"mqtt in","z":"5c84935c.97f78c","name":"","topic":"drone/speed","qos":"1","datatype":"json","broker":"8c2c482d.c4ae48","x":90,"y":1200,"wires":[["6ec83642.87cdc8"]]},{"id":"15920f0a.2ff8e1","type":"mqtt in","z":"5c84935c.97f78c","name":"","topic":"drone/orientation","qos":"1","datatype":"json","broker":"8c2c482d.c4ae48","x":100,"y":1260,"wires":[["6ec83642.87cdc8"]]},{"id":"526e6adb.113044","type":"function","z":"5c84935c.97f78c","name":"convertPayload","func":"let subs = global.get('subscriptions') || {};\nmsg.subs = subs;\n\nlet properties = {};\n\nif(Object.keys(subs).length) {\n    for (let key in subs){\n        if(subs[key] === true)\n            properties[key] = global.get('drone/' + key);\n    }\n}\nproperties['radius'] = global.get('drone/radius');\n\nlet position = subs['position'] ? global.get('drone/position') : {\"x\":0, \"y\":0, \"z\":0};\nlet geoJSON = {\n            \"type\": \"FeatureCollection\",\n            \"features\": [{\n                \"type\": \"Feature\",\n                \"properties\": properties,\n                \"geometry\": {\n                    \"type\": \"Point\",\n                    \"coordinates\": [position.x, position.y, position.z]\n                }\n            }]\n        };\n        \nmsg.payload = geoJSON;\nreturn msg;","outputs":1,"noerr":0,"x":920,"y":1120,"wires":[["d6ffcf22.30126"]]},{"id":"d6ffcf22.30126","type":"websocket out","z":"5c84935c.97f78c","name":"","server":"","client":"","x":1150,"y":1120,"wires":[]},{"id":"31baf96b.2482d6","type":"http in","z":"5c84935c.97f78c","name":"","url":"/drone","method":"put","upload":false,"swaggerDoc":"","x":100,"y":1320,"wires":[["e5422eff.2e9a5"]]},{"id":"ab717498.bcf178","type":"function","z":"5c84935c.97f78c","name":"drone/radius","func":"msg.topic = 'drone/radius';\n\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":1320,"wires":[["f2ae66f2.55c8b8","64220df1.240484"]]},{"id":"e5422eff.2e9a5","type":"template","z":"5c84935c.97f78c","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{payload}}","output":"json","x":280,"y":1320,"wires":[["ab717498.bcf178"]]},{"id":"6ec83642.87cdc8","type":"json","z":"5c84935c.97f78c","name":"","property":"payload","action":"obj","pretty":false,"x":330,"y":1120,"wires":[["64220df1.240484"]]},{"id":"f2ae66f2.55c8b8","type":"http response","z":"5c84935c.97f78c","name":"","statusCode":"200","headers":{},"x":620,"y":1320,"wires":[]},{"id":"64220df1.240484","type":"change","z":"5c84935c.97f78c","name":"set msg.topic for caching","rules":[{"t":"set","p":"topic","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":690,"y":1120,"wires":[["526e6adb.113044"]]},{"id":"3914c3dc.e762cc","type":"mqtt in","z":"5c84935c.97f78c","name":"","topic":"drone/scanned","qos":"1","datatype":"auto","broker":"588ab8f8.87bb48","x":100,"y":1880,"wires":[["a356d887.090168","9b4dce0.221653"]]},{"id":"1f83e52c.44776b","type":"http request","z":"5c84935c.97f78c","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"http://localhost:3000/api/maps/{{{mapid}}}/scanzones/{{{scanzoneid}}}/products","tls":"","proxy":"","authType":"basic","x":810,"y":1900,"wires":[["ff8361b2.2924b"]]},{"id":"ff8361b2.2924b","type":"switch","z":"5c84935c.97f78c","name":"","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1010,"y":1880,"wires":[["a81be9e9.f4e148"]]},{"id":"a356d887.090168","type":"function","z":"5c84935c.97f78c","name":"next destination","func":"var moveteller = global.get('moveteller');\nvar waypoints = global.get('waypoints');\nvar stop = global.get('stop');\n\nif(moveteller < waypoints.waypoints.length) {\n    msg.payload = waypoints.waypoints[moveteller++];\n    global.set('destination',msg.payload);\n}\nelse{\n    stop = true;\n}\n/*else {\n    //positie om terug te keren\n    moveteller -= 2;\n    stop = true;\n}*/\n\nglobal.set('moveteller', moveteller);\nglobal.set('stop', stop);\nglobal.set('scanning', false);\n\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":1940,"wires":[["ce3ae38b.2173f"]]},{"id":"a81be9e9.f4e148","type":"debug","z":"5c84935c.97f78c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1170,"y":1880,"wires":[]},{"id":"ce3ae38b.2173f","type":"mqtt out","z":"5c84935c.97f78c","name":"","topic":"drone/moveto","qos":"","retain":"","broker":"588ab8f8.87bb48","x":520,"y":1940,"wires":[]},{"id":"9b4dce0.221653","type":"json","z":"5c84935c.97f78c","name":"","property":"payload","action":"obj","pretty":false,"x":290,"y":1880,"wires":[["29d891dd.83c1fe"]]},{"id":"29d891dd.83c1fe","type":"function","z":"5c84935c.97f78c","name":"set urldata","func":"msg.post = msg.payload.post\n\nmsg.mapid = global.get('mapid')\nmsg.scanzoneid = msg.payload.scanzoneId\nmsg.productid = msg.payload.product._id\n\nmsg.payload = msg.payload.product\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":1880,"wires":[["3024a821.61c588"]]},{"id":"3024a821.61c588","type":"switch","z":"5c84935c.97f78c","name":"","property":"post","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":630,"y":1880,"wires":[["f0ab9bd2.beb218"],["1f83e52c.44776b"]]},{"id":"f0ab9bd2.beb218","type":"http request","z":"5c84935c.97f78c","name":"","method":"PUT","ret":"txt","paytoqs":false,"url":"http://localhost:3000/api/maps/{{{mapid}}}/scanzones/{{{scanzoneid}}}/products/{{productid}}","tls":"","proxy":"","authType":"basic","x":810,"y":1860,"wires":[["ff8361b2.2924b"]]},{"id":"6f2e195f.d36788","type":"function","z":"5c84935c.97f78c","name":"drone arrived at his destination within a certain radius?","func":"var stop = global.get('stop') || false;\nvar moveteller = global.get('moveteller');\nvar destination = global.get('destination');\nvar diffX = Math.abs(msg.payload.x - destination.x);\nvar diffY = Math.abs(msg.payload.y - destination.y);\n//geeft aan of gescant moet worden op de destination\nvar scan = destination.scan;\nvar waypoints = global.get('waypoints');\n\n//enkel in de eerste if moet hij checken om te scannen\nif(stop === false && (diffX <= 20 && diffY <= 20)) {\n    //toegekomen dus eerst checken of hij moet scannen voor hij verder gaat\n    //wnr niet moet gescant worden, zoals anders\n    global.set('arrived', true);\n    if(scan === false) {\n        if(moveteller < waypoints.waypoints.length) {\n            msg.payload = waypoints.waypoints[moveteller++];\n            global.set('destination',msg.payload);\n        }\n        else {\n            //alle waypoints zijn doorlopen dus de drone moet stoppen\n            stop = true;\n        }\n    }\n    //wnr wel moet gescant worden, wordt de volgende positie ingesteld na de scan\n    else {\n        global.set('scanning',scan);\n        msg.payload = waypoints.waypoints[moveteller-1].scanzone;\n    }\n}\nglobal.set('moveteller', moveteller);\nglobal.set('stop', stop);\nreturn msg;","outputs":1,"noerr":0,"x":860,"y":1400,"wires":[["d58a641a.1b2d08"]]},{"id":"3d32ff46.31312","type":"json","z":"5c84935c.97f78c","name":"","property":"payload","action":"obj","pretty":false,"x":570,"y":1400,"wires":[["6f2e195f.d36788"]]},{"id":"28996ef5.e2aa62","type":"switch","z":"5c84935c.97f78c","name":"scanning?","property":"scanning","propertyType":"global","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":400,"y":1400,"wires":[["3d32ff46.31312"]]},{"id":"43343ead.fc174","type":"switch","z":"5c84935c.97f78c","name":"flying?","property":"flying","propertyType":"global","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":250,"y":1400,"wires":[["28996ef5.e2aa62"]]},{"id":"917cc1f6.11cc1","type":"mqtt in","z":"5c84935c.97f78c","name":"","topic":"drone/position","qos":"2","datatype":"json","broker":"588ab8f8.87bb48","x":90,"y":1400,"wires":[["43343ead.fc174"]]},{"id":"24f9d9ee.3da586","type":"mqtt out","z":"5c84935c.97f78c","name":"","topic":"drone/moveto","qos":"","retain":"","broker":"588ab8f8.87bb48","x":1240,"y":1600,"wires":[]},{"id":"c62426e7.7ca438","type":"switch","z":"5c84935c.97f78c","name":"scanning?","property":"scanning","propertyType":"global","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":430,"y":1620,"wires":[["97223669.424c58"],["cb2b7454.22c888"]]},{"id":"cb2b7454.22c888","type":"mqtt out","z":"5c84935c.97f78c","name":"","topic":"drone/scanner","qos":"1","retain":"","broker":"588ab8f8.87bb48","x":620,"y":1640,"wires":[]},{"id":"6865a4cb.6d7bec","type":"change","z":"5c84935c.97f78c","name":"arrived = false","rules":[{"t":"set","p":"arrived","pt":"global","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":820,"y":1600,"wires":[["4e506562.e0c01c"]]},{"id":"97223669.424c58","type":"switch","z":"5c84935c.97f78c","name":"arrived = true?","property":"arrived","propertyType":"global","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":620,"y":1600,"wires":[["6865a4cb.6d7bec"]]},{"id":"4e506562.e0c01c","type":"switch","z":"5c84935c.97f78c","name":"needs scanning?","property":"payload.scan","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":1030,"y":1600,"wires":[["24f9d9ee.3da586"]]},{"id":"d58a641a.1b2d08","type":"switch","z":"5c84935c.97f78c","name":"stop?","property":"stop","propertyType":"global","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":270,"y":1640,"wires":[["c62426e7.7ca438"],["42529ae.009a864"]]},{"id":"72d7b3a.e741b4c","type":"mqtt out","z":"5c84935c.97f78c","name":"","topic":"drone/pause","qos":"","retain":"","broker":"588ab8f8.87bb48","x":630,"y":1700,"wires":[]},{"id":"42529ae.009a864","type":"change","z":"5c84935c.97f78c","name":"","rules":[{"t":"set","p":"flying","pt":"global","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":440,"y":1700,"wires":[["72d7b3a.e741b4c"]]},{"id":"e832c88e.e67de8","type":"http request","z":"8d375144.8b6bc","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"http://localhost:3000/api/maps/{{{mapid}}}/scanzones/{{{scanzoneid}}}/products","tls":"","proxy":"","authType":"basic","x":810,"y":440,"wires":[["fbd8b3d5.fa598"]]},{"id":"c025dc4a.0bbb8","type":"http response","z":"8d375144.8b6bc","name":"","statusCode":"200","headers":{},"x":680,"y":60,"wires":[]},{"id":"29313d56.daa1c2","type":"http in","z":"8d375144.8b6bc","name":"","url":"/path/set","method":"post","upload":false,"swaggerDoc":"","x":210,"y":60,"wires":[["8832727d.bf6a"]]},{"id":"90ad0cf3.e285c","type":"function","z":"8d375144.8b6bc","name":"radius - arrived?","func":"var stop = flow.get('stop') || false;\nvar moveteller = flow.get('moveteller');\nvar destination = flow.get('destination');\nvar diffX = Math.abs(msg.payload.x - destination.x);\nvar diffY = Math.abs(msg.payload.y - destination.y);\nvar scan = destination.scan;\nvar waypoints = flow.get('waypoints');\n\n//enkel in de eerste if moet hij checken om te scannen\nif(stop === false && (diffX <= 20 && diffY <= 20)) {\n    //toegekomen dus eerst checken of hij moet scannen voor hij verder gaat\n    //wnr niet moet gescant worden, zoals anders\n    flow.set('arrived', true);\n    if(scan === false) {\n        if(moveteller < waypoints.waypoints.length) {\n            msg.payload = waypoints.waypoints[moveteller++];\n            flow.set('destination',msg.payload);\n        }\n        else {\n            stop = true;\n        }\n    }\n    //wnr wel moet gescant worden, wordt de volgende positie ingesteld na de scan\n    else {\n        flow.set('scanning',scan);\n        msg.payload = waypoints.waypoints[moveteller-1].scanzone;\n    }\n}\n/*\nif(stop === true && (diffX <= waypoints.radius && diffY <= waypoints.radius)) {\n    if(moveteller >= 0) {\n        msg.payload = waypoints.waypoints[moveteller--];\n        flow.set('destination', msg.payload);\n    }\n    else {\n        // hier zal een commando komen om de drone te laten landen, anders gaat hij verder gaan in een loop want stop komt op false\n        stop = false;\n    }\n}\n*/\nflow.set('moveteller', moveteller);\nflow.set('stop', stop);\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":280,"wires":[["b62fa08.290bb6"]]},{"id":"4a2dafe8.1957a","type":"mqtt out","z":"8d375144.8b6bc","name":"","topic":"drone/moveto","qos":"","retain":"","broker":"b529c024.9e935","x":1840,"y":240,"wires":[]},{"id":"3a4ef1c2.62300e","type":"json","z":"8d375144.8b6bc","name":"","property":"payload","action":"obj","pretty":false,"x":590,"y":280,"wires":[["90ad0cf3.e285c"]]},{"id":"cccb4379.837f8","type":"switch","z":"8d375144.8b6bc","name":"scanning?","property":"scanning","propertyType":"flow","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":420,"y":280,"wires":[["3a4ef1c2.62300e"]]},{"id":"752a0907.ea5788","type":"switch","z":"8d375144.8b6bc","name":"scanning?","property":"scanning","propertyType":"flow","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":1070,"y":260,"wires":[["d92b95d4.26e9e8"],["ced696ee.a02a58"]]},{"id":"ced696ee.a02a58","type":"mqtt out","z":"8d375144.8b6bc","name":"","topic":"drone/scanner","qos":"1","retain":"","broker":"b529c024.9e935","x":1280,"y":280,"wires":[]},{"id":"21c9974.be9a068","type":"mqtt in","z":"8d375144.8b6bc","name":"","topic":"drone/scanned","qos":"1","datatype":"auto","broker":"b529c024.9e935","x":100,"y":420,"wires":[["3bad11e3.c068ae","f0a0812a.9a2c4"]]},{"id":"31371ffc.c9b4e","type":"change","z":"8d375144.8b6bc","name":"","rules":[{"t":"set","p":"arrived","pt":"flow","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1420,"y":220,"wires":[["fbf8304b.b39b3"]]},{"id":"d92b95d4.26e9e8","type":"switch","z":"8d375144.8b6bc","name":"arrived?","property":"arrived","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1260,"y":220,"wires":[["31371ffc.c9b4e"]]},{"id":"2476f599.afa01a","type":"mqtt in","z":"8d375144.8b6bc","name":"","topic":"drone/battery","qos":"1","datatype":"json","broker":"b529c024.9e935","x":390,"y":780,"wires":[["b52dc68.962cb38"]]},{"id":"1cfbfbc4.30ce54","type":"mqtt in","z":"8d375144.8b6bc","name":"","topic":"drone/position","qos":"2","datatype":"json","broker":"b529c024.9e935","x":70,"y":640,"wires":[["c745c210.d8a84","dc98cd66.bc1ba"]]},{"id":"9fe3054f.3c4b98","type":"mqtt in","z":"8d375144.8b6bc","name":"","topic":"drone/acceleration","qos":"1","datatype":"json","broker":"b529c024.9e935","x":390,"y":660,"wires":[["b52dc68.962cb38"]]},{"id":"bc44647e.fd7248","type":"mqtt in","z":"8d375144.8b6bc","name":"","topic":"drone/speed","qos":"1","datatype":"json","broker":"b529c024.9e935","x":410,"y":700,"wires":[["b52dc68.962cb38"]]},{"id":"9d88c37c.c1dea","type":"mqtt in","z":"8d375144.8b6bc","name":"","topic":"drone/orientation","qos":"1","datatype":"json","broker":"b529c024.9e935","x":400,"y":740,"wires":[["b52dc68.962cb38"]]},{"id":"f808b7b3.8ff828","type":"function","z":"8d375144.8b6bc","name":"convertPayload","func":"let subs = global.get('subscriptions') || {};\nmsg.subs = subs;\n\nlet properties = {};\n\nif(Object.keys(subs).length) {\n    for (let key in subs){\n        if(subs[key] === true)\n            properties[key] = flow.get('drone/' + key);\n    }\n}\nproperties['radius'] = flow.get('drone/radius');\n\nlet position = subs['position'] ? flow.get('drone/position') : {\"x\":0, \"y\":0, \"z\":0};\nlet geoJSON = {\n            \"type\": \"FeatureCollection\",\n            \"features\": [{\n                \"type\": \"Feature\",\n                \"properties\": properties,\n                \"geometry\": {\n                    \"type\": \"Point\",\n                    \"coordinates\": [position.x, position.y, position.z]\n                }\n            }]\n        };\n        \nmsg.payload = geoJSON;\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":660,"wires":[["98f82080.2d9fd","cc7a8353.2eeca"]]},{"id":"d5a83fea.c1468","type":"http in","z":"8d375144.8b6bc","name":"","url":"/data","method":"put","upload":false,"swaggerDoc":"","x":70,"y":1460,"wires":[["7e27cee7.4a09f"]]},{"id":"7e27cee7.4a09f","type":"function","z":"8d375144.8b6bc","name":"specifySubs","func":"let sub = global.get(\"subscriptions\") || {};\nfor(let key in msg.payload){\n    console.log(key);\n    if(msg.payload[key] == true)\n        sub[key] = true;\n    else sub[key] = false;\n    \n}\nglobal.set(\"subscriptions\", sub);\n\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":1460,"wires":[["c96b6413.a6a5f8"]]},{"id":"6c668790.65e028","type":"http response","z":"8d375144.8b6bc","name":"","statusCode":"200","headers":{},"x":740,"y":1500,"wires":[]},{"id":"cb7dbfb2.ae82","type":"function","z":"8d375144.8b6bc","name":"setAllSubs","func":"let sub = global.get(\"subscriptions\") || {};\nsub.acceleration = true;\nsub.speed = true;\nsub.orientation = true;\nsub.position = true;\nsub.battery = true;\nglobal.set(\"subscriptions\", sub);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":290,"y":1540,"wires":[["c96b6413.a6a5f8"]]},{"id":"98f82080.2d9fd","type":"websocket out","z":"8d375144.8b6bc","name":"","server":"1a7c075d.2f6a49","client":"","x":1170,"y":660,"wires":[]},{"id":"65748c6e.7cfff4","type":"http in","z":"8d375144.8b6bc","name":"","url":"/data/all","method":"put","upload":false,"swaggerDoc":"","x":80,"y":1540,"wires":[["cb7dbfb2.ae82"]]},{"id":"231181be.17955e","type":"http in","z":"8d375144.8b6bc","name":"","url":"/data/none","method":"put","upload":false,"swaggerDoc":"","x":90,"y":1580,"wires":[["e3c28d4b.6b84b"]]},{"id":"e3c28d4b.6b84b","type":"function","z":"8d375144.8b6bc","name":"clearSubs","func":"global.set(\"subscriptions\", {});\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":1580,"wires":[["c96b6413.a6a5f8"]]},{"id":"c96b6413.a6a5f8","type":"function","z":"8d375144.8b6bc","name":"generatePayload","func":"let sub = global.get(\"subscriptions\") || {};\n\nfor(let key of Object.keys(sub)){\n    msg.payload[key] = sub[key];\n}\n//msg.payload = flow.get(\"drone/\" + msg.req.query);\nmsg.subs = global.subscriptions;\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":1500,"wires":[["6c668790.65e028","4b0d3a34.addaf4"]]},{"id":"2d62f410.68ad6c","type":"http in","z":"8d375144.8b6bc","name":"","url":"/drone","method":"put","upload":false,"swaggerDoc":"","x":100,"y":860,"wires":[["f8bd8aa7.ba6a68"]]},{"id":"8606b8c4.98aee8","type":"function","z":"8d375144.8b6bc","name":"drone/radius","func":"msg.topic = 'drone/radius';\n\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":900,"wires":[["c03ff57d.49b0f8","7fadd39c.2ef08c"]]},{"id":"f8bd8aa7.ba6a68","type":"template","z":"8d375144.8b6bc","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{payload}}","output":"json","x":280,"y":860,"wires":[["8606b8c4.98aee8","54b8db21.c69cd4"]]},{"id":"c03ff57d.49b0f8","type":"debug","z":"8d375144.8b6bc","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":640,"y":900,"wires":[]},{"id":"b52dc68.962cb38","type":"json","z":"8d375144.8b6bc","name":"","property":"payload","action":"obj","pretty":false,"x":590,"y":660,"wires":[["f808b7b3.8ff828"]]},{"id":"59a3bb26.444b54","type":"debug","z":"8d375144.8b6bc","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":950,"y":1460,"wires":[]},{"id":"4b0d3a34.addaf4","type":"change","z":"8d375144.8b6bc","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"subscriptions","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":760,"y":1460,"wires":[["59a3bb26.444b54"]]},{"id":"2e0a387a.1b5618","type":"http in","z":"8d375144.8b6bc","name":"","url":"/data","method":"get","upload":false,"swaggerDoc":"","x":70,"y":1500,"wires":[["c96b6413.a6a5f8"]]},{"id":"cc7a8353.2eeca","type":"debug","z":"8d375144.8b6bc","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1170,"y":620,"wires":[]},{"id":"370d1c2.fcc6ee4","type":"link in","z":"8d375144.8b6bc","name":"drone/position","links":["c745c210.d8a84"],"x":155,"y":280,"wires":[["7a8c95bc.ae460c"]]},{"id":"c745c210.d8a84","type":"link out","z":"8d375144.8b6bc","name":"","links":["370d1c2.fcc6ee4","1a7442e8.b5239d"],"x":215,"y":640,"wires":[]},{"id":"54b8db21.c69cd4","type":"debug","z":"8d375144.8b6bc","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":450,"y":840,"wires":[]},{"id":"7fadd39c.2ef08c","type":"http response","z":"8d375144.8b6bc","name":"","statusCode":"200","headers":{},"x":640,"y":940,"wires":[]},{"id":"9b1e86d6.f4dd28","type":"http in","z":"8d375144.8b6bc","name":"","url":"drone/start","method":"post","upload":false,"swaggerDoc":"","x":120,"y":1140,"wires":[["ba5af98c.17b928"]]},{"id":"28df4999.affe06","type":"http in","z":"8d375144.8b6bc","name":"","url":"drone/pause","method":"post","upload":false,"swaggerDoc":"","x":100,"y":1240,"wires":[["576c85ca.02ba4c"]]},{"id":"576c85ca.02ba4c","type":"function","z":"8d375144.8b6bc","name":"set statusinfo","func":"flow.set('flying', false);\n\nflow.set('statusinfo', {\"validated\": true, \"sent\": true, \"flying\": false});\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":1240,"wires":[["f5f539e8.4cc8f8","cc1d7286.fd157"]]},{"id":"ba5af98c.17b928","type":"switch","z":"8d375144.8b6bc","name":"","property":"destination","propertyType":"flow","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":350,"y":1140,"wires":[["516d9777.cc6828"],["50b9f17b.cf3d2"]]},{"id":"50b9f17b.cf3d2","type":"http response","z":"8d375144.8b6bc","name":"","statusCode":"500","headers":{},"x":520,"y":1160,"wires":[]},{"id":"516d9777.cc6828","type":"function","z":"8d375144.8b6bc","name":"send dest + statusinfo","func":"flow.set('statusinfo', {\"validated\": true, \"sent\": true, \"flying\": true});\nflow.set('flying', true);\n\nmsg.payload = flow.get('destination');\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":1120,"wires":[["60dd084a.8377f8","1f76d8c.b799127","3252de8b.83dbf2"]]},{"id":"f5f539e8.4cc8f8","type":"http response","z":"8d375144.8b6bc","name":"","statusCode":"200","headers":{},"x":540,"y":1220,"wires":[]},{"id":"7a8c95bc.ae460c","type":"switch","z":"8d375144.8b6bc","name":"flying?","property":"flying","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":270,"y":280,"wires":[["cccb4379.837f8"]]},{"id":"cc1d7286.fd157","type":"mqtt out","z":"8d375144.8b6bc","name":"","topic":"drone/pause","qos":"1","retain":"","broker":"b529c024.9e935","x":550,"y":1260,"wires":[]},{"id":"8832727d.bf6a","type":"function","z":"8d375144.8b6bc","name":"setvariabelen","func":"var moveteller = 1;\n\n\nflow.set('waypoints',msg.payload);\nmsg.payload = flow.get('waypoints').waypoints[moveteller++];\nflow.set('mapid', flow.get('waypoints').mapId);\nflow.set(\"destination\", msg.payload);\nflow.set('moveteller', moveteller);\n//reset want nieuwe coo om naartoe te gaan\nflow.set('stop',false);\nflow.set('scanning', false);\nflow.set('arrived', false);\n\n\nflow.set('flying', false)\n\nflow.set('statusinfo', {\"validated\": true, \"sent\": true, \"flying\": false});\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":60,"wires":[["c025dc4a.0bbb8","20286fd8.b805c"]]},{"id":"60dd084a.8377f8","type":"mqtt out","z":"8d375144.8b6bc","name":"","topic":"drone/start","qos":"1","retain":"","broker":"b529c024.9e935","x":830,"y":1040,"wires":[]},{"id":"7e485d2d.d05e84","type":"http in","z":"8d375144.8b6bc","name":"","url":"/statusinfo","method":"get","upload":false,"swaggerDoc":"","x":110,"y":1060,"wires":[["1ee1e401.ca9a7c"]]},{"id":"1ee1e401.ca9a7c","type":"function","z":"8d375144.8b6bc","name":"get info","func":"msg.payload = flow.get('statusinfo') || {\"validated\": false, \"sent\": false, \"flying\": false};\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":1060,"wires":[["e739c70f.396318"]]},{"id":"e739c70f.396318","type":"http response","z":"8d375144.8b6bc","name":"","statusCode":"200","headers":{},"x":510,"y":1060,"wires":[]},{"id":"17261f2.5309ee1","type":"http request","z":"8d375144.8b6bc","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"http://localhost:3000/api/flightpath","tls":"","proxy":"","authType":"basic","x":470,"y":100,"wires":[["7a626747.41d798"]]},{"id":"41ae9f50.88e68","type":"http in","z":"8d375144.8b6bc","name":"","url":"/path/validate","method":"post","upload":false,"swaggerDoc":"","x":220,"y":100,"wires":[["17261f2.5309ee1"]]},{"id":"989289b1.041c58","type":"function","z":"8d375144.8b6bc","name":"setvariabelen","func":"flow.set('statusinfo', {\"validated\": true, \"sent\": false, \"flying\": false});\nreturn msg;","outputs":1,"noerr":0,"x":930,"y":60,"wires":[["c9cf81d.2ba968"]]},{"id":"7a626747.41d798","type":"switch","z":"8d375144.8b6bc","name":"","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"neq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":680,"y":100,"wires":[["989289b1.041c58"],["78e2bd34.ab6284"]]},{"id":"78e2bd34.ab6284","type":"function","z":"8d375144.8b6bc","name":"setvariabelen","func":"flow.set('statusinfo', {\"validated\": false, \"sent\": false, \"flying\": false});\nreturn msg;","outputs":1,"noerr":0,"x":930,"y":120,"wires":[["353a2483.537cfc"]]},{"id":"c9cf81d.2ba968","type":"http response","z":"8d375144.8b6bc","name":"","statusCode":"200","headers":{},"x":1160,"y":60,"wires":[]},{"id":"353a2483.537cfc","type":"http response","z":"8d375144.8b6bc","name":"","statusCode":"500","headers":{},"x":1160,"y":120,"wires":[]},{"id":"1f76d8c.b799127","type":"http response","z":"8d375144.8b6bc","name":"","statusCode":"200","headers":{},"x":820,"y":1120,"wires":[]},{"id":"7751570c.ae56d8","type":"http in","z":"8d375144.8b6bc","name":"","url":"drone/stop","method":"post","upload":false,"swaggerDoc":"","x":100,"y":1320,"wires":[["e5880526.7681c8"]]},{"id":"e5880526.7681c8","type":"function","z":"8d375144.8b6bc","name":"set statusinfo","func":"flow.set('flying', false);\n\nflow.set('statusinfo', {\"validated\": false, \"sent\": false, \"flying\": false});\n\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":1320,"wires":[["f45e14cd.19c148","c4459fab.62c78"]]},{"id":"f45e14cd.19c148","type":"http response","z":"8d375144.8b6bc","name":"","statusCode":"200","headers":{},"x":500,"y":1320,"wires":[]},{"id":"c4459fab.62c78","type":"mqtt out","z":"8d375144.8b6bc","name":"","topic":"drone/stop","qos":"1","retain":"","broker":"b529c024.9e935","x":490,"y":1360,"wires":[]},{"id":"ab913f37.69c79","type":"debug","z":"8d375144.8b6bc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1830,"y":200,"wires":[]},{"id":"dc98cd66.bc1ba","type":"debug","z":"8d375144.8b6bc","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":160,"y":720,"wires":[]},{"id":"3252de8b.83dbf2","type":"debug","z":"8d375144.8b6bc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":830,"y":1000,"wires":[]},{"id":"5cd6d364.dc98ec","type":"mqtt in","z":"8d375144.8b6bc","name":"","topic":"drone/start","qos":"1","datatype":"auto","broker":"b529c024.9e935","x":1050,"y":1060,"wires":[["35456eb8.4d62a2"]]},{"id":"35456eb8.4d62a2","type":"mqtt out","z":"8d375144.8b6bc","name":"","topic":"drone/moveto","qos":"1","retain":"","broker":"b529c024.9e935","x":1240,"y":1060,"wires":[]},{"id":"1a7442e8.b5239d","type":"link in","z":"8d375144.8b6bc","name":"","links":["c745c210.d8a84"],"x":455,"y":600,"wires":[["b52dc68.962cb38"]]},{"id":"d1b05ffd.3118","type":"debug","z":"8d375144.8b6bc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":850,"y":20,"wires":[]},{"id":"20286fd8.b805c","type":"change","z":"8d375144.8b6bc","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"waypoints","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":660,"y":20,"wires":[["d1b05ffd.3118"]]},{"id":"310bcd81.f5ff02","type":"comment","z":"8d375144.8b6bc","name":"","info":"Eerst moet hij de juiste scangegevens doorsturen naar de drone\nEenmaal gescant, moeten de juiste gegevens in de databank worden opgeslaan (API endpoint)\n-moet nog gebeuren-","x":220,"y":360,"wires":[]},{"id":"fbd8b3d5.fa598","type":"switch","z":"8d375144.8b6bc","name":"","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1010,"y":420,"wires":[["40327301.4f2f8c"]]},{"id":"3bad11e3.c068ae","type":"function","z":"8d375144.8b6bc","name":"next destination","func":"var moveteller = flow.get('moveteller');\nvar waypoints = flow.get('waypoints');\nvar stop = flow.get('stop');\n\nif(moveteller < waypoints.waypoints.length) {\n    msg.payload = waypoints.waypoints[moveteller++];\n    flow.set('destination',msg.payload);\n}\nelse {\n    stop = true;\n}\n/*else {\n    //positie om terug te keren\n    moveteller -= 2;\n    stop = true;\n}*/\n\nflow.set('moveteller', moveteller);\nflow.set('stop', stop);\nflow.set('scanning', false);\n\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":480,"wires":[["9e1de5cb.6757f8"]]},{"id":"40327301.4f2f8c","type":"debug","z":"8d375144.8b6bc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1170,"y":420,"wires":[]},{"id":"9e1de5cb.6757f8","type":"mqtt out","z":"8d375144.8b6bc","name":"","topic":"drone/moveto","qos":"","retain":"","broker":"b529c024.9e935","x":550,"y":480,"wires":[]},{"id":"fbf8304b.b39b3","type":"switch","z":"8d375144.8b6bc","name":"needs scanning?","property":"payload.scan","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":1630,"y":220,"wires":[["4a2dafe8.1957a","ab913f37.69c79"]]},{"id":"f0a0812a.9a2c4","type":"json","z":"8d375144.8b6bc","name":"","property":"payload","action":"obj","pretty":false,"x":290,"y":420,"wires":[["a082b758.138488"]]},{"id":"a082b758.138488","type":"function","z":"8d375144.8b6bc","name":"set urldata","func":"msg.post = msg.payload.post\n\nmsg.mapid = flow.get('mapid')\nmsg.scanzoneid = msg.payload.scanzoneId\nmsg.productid = msg.payload.product._id\n\nmsg.payload = msg.payload.product\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":420,"wires":[["651e3c6b.132614"]]},{"id":"651e3c6b.132614","type":"switch","z":"8d375144.8b6bc","name":"","property":"post","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":630,"y":420,"wires":[["6de6f551.86527c"],["e832c88e.e67de8"]]},{"id":"6de6f551.86527c","type":"http request","z":"8d375144.8b6bc","name":"","method":"PUT","ret":"txt","paytoqs":false,"url":"http://localhost:3000/api/maps/{{{mapid}}}/scanzones/{{{scanzoneid}}}/products/{{productid}}","tls":"","proxy":"","authType":"basic","x":810,"y":400,"wires":[["fbd8b3d5.fa598"]]},{"id":"b62fa08.290bb6","type":"switch","z":"8d375144.8b6bc","name":"stop?","property":"stop","propertyType":"flow","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":910,"y":280,"wires":[["752a0907.ea5788"],["212d1aa.1a086e6"]]},{"id":"ddfe4d77.16e47","type":"mqtt out","z":"8d375144.8b6bc","name":"","topic":"drone/pause","qos":"","retain":"","broker":"b529c024.9e935","x":1270,"y":340,"wires":[]},{"id":"212d1aa.1a086e6","type":"change","z":"8d375144.8b6bc","name":"","rules":[{"t":"set","p":"flying","pt":"flow","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1070,"y":340,"wires":[["ddfe4d77.16e47"]]},{"id":"13535f9a.6c06","type":"http in","z":"8d375144.8b6bc","name":"","url":"drone/homebase","method":"post","upload":false,"swaggerDoc":"","x":120,"y":1620,"wires":[["a4a4296c.26bbc8","17d76341.28c55d"]]},{"id":"a4a4296c.26bbc8","type":"mqtt out","z":"8d375144.8b6bc","name":"","topic":"drone/homebase","qos":"","retain":"","broker":"b529c024.9e935","x":450,"y":1620,"wires":[]},{"id":"17d76341.28c55d","type":"http response","z":"8d375144.8b6bc","name":"","statusCode":"200","headers":{},"x":420,"y":1660,"wires":[]}]