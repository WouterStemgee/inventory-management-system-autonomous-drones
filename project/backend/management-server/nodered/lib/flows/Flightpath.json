[{"id":"5f40152a.abdecc","type":"http request","z":"750f717a.6879a8","name":"flightpath request","method":"POST","ret":"obj","paytoqs":false,"url":"http://localhost:3000/api/flightpath","tls":"","proxy":"","authType":"basic","x":310,"y":160,"wires":[["a1f844fd.d32488"]]},{"id":"ca8c40db.cc89","type":"http response","z":"750f717a.6879a8","name":"","statusCode":"200","headers":{},"x":640,"y":140,"wires":[]},{"id":"a1f844fd.d32488","type":"switch","z":"750f717a.6879a8","name":"","property":"statuscode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"neq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":490,"y":160,"wires":[["ca8c40db.cc89","281e19e2.9b96de"],["5d05ebcc.1ff32c"]]},{"id":"7477a927.456518","type":"http in","z":"750f717a.6879a8","name":"","url":"astar","method":"post","upload":false,"swaggerDoc":"","x":100,"y":160,"wires":[["5f40152a.abdecc"]]},{"id":"5d05ebcc.1ff32c","type":"http response","z":"750f717a.6879a8","name":"","statusCode":"500","headers":{},"x":640,"y":180,"wires":[]},{"id":"7d7920e6.a6ebe8","type":"inject","z":"750f717a.6879a8","name":"","topic":"","payload":"{\"waypoints\":[{\"x\":2.2,\"y\":2.2,\"scan\":true},{\"x\":2.2,\"y\":15.4,\"scan\":false},{\"x\":10.5,\"y\":15.4,\"scan\":true}]}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":490,"y":100,"wires":[["281e19e2.9b96de"]]},{"id":"a812ca0.0a96cb8","type":"mqtt out","z":"750f717a.6879a8","name":"","topic":"drone/moveto","qos":"1","retain":"","broker":"3e7c6df.4bd9f92","x":840,"y":100,"wires":[]},{"id":"281e19e2.9b96de","type":"function","z":"750f717a.6879a8","name":"setvariabelen","func":"var waypoints = flow.get('waypoints') || {};\nvar moveteller = 0;\nvar destination = flow.get(\"destination\") || {};\n\nflow.set('waypoints',msg.payload);\nmsg.payload = flow.get('waypoints').waypoints[moveteller++]\nflow.set(\"destination\", msg.payload);\nflow.set('moveteller', moveteller);\n//reset want nieuwe coo om naartoe te gaan\nflow.set('stop',false);\nflow.set('scanning', false);\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":100,"wires":[["a812ca0.0a96cb8"]]},{"id":"2b60f326.77e66c","type":"mqtt in","z":"750f717a.6879a8","name":"","topic":"drone/position","qos":"1","datatype":"auto","broker":"3e7c6df.4bd9f92","x":100,"y":280,"wires":[["37cafee1.f841c2"]]},{"id":"a886ad02.a098d","type":"function","z":"750f717a.6879a8","name":"radius - arrived?","func":"var stop = flow.get('stop') || false;\nvar moveteller = flow.get('moveteller');\nvar diffX = Math.abs(msg.payload.x - flow.get('destination').x);\nvar diffY = Math.abs(msg.payload.y - flow.get('destination').y);\nvar scan = flow.get('destination').scan;\n\n//enkel in de eerste if moet hij checken om te scannen\nif(stop === false && (diffX <= 0.1 && diffY <= 0.1)) {\n    //toegekomen dus eerst checken of hij moet scannen voor hij verder gaat\n    //wnr niet moet gescant worden, zoals anders\n    if(scan === false) {\n        if(moveteller < flow.get('waypoints').waypoints.length) {\n            msg.payload = flow.get('waypoints').waypoints[moveteller++];\n            flow.set('destination',msg.payload);\n        }\n        else {\n            //positie om terug te keren\n            moveteller -= 2;\n            stop = true;\n        }\n    }\n    //wnr wel moet gescant worden, wordt de volgende positie ingesteld na de scan\n    else {\n        flow.set('scanning',scan);\n    }\n}\nif(stop === true && (diffX <= 0.1 && diffY <= 0.1)) {\n    if(moveteller >= 0) {\n        msg.payload = flow.get('waypoints').waypoints[moveteller--];\n        flow.set('destination', msg.payload);\n    }\n    else {\n        // hier zal een commando komen om de drone te laten landen, anders gaat hij verder gaan in een loop want stop komt op false\n        stop = false;\n    }\n}\nflow.set('moveteller', moveteller);\nflow.set('stop', stop);\n//flow.set('diffX', diffX);\n//flow.set('diffY', diffY);\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":280,"wires":[["beed125d.469ee8","f4706ab3.451c7","8f9e4c7f.af0b2","efa301c0.084df8","5a6bc7b5.a63e6","c992eb78.1a765","74f7a9cd.d16ba","430b31c8.22de"]]},{"id":"6337c49b.eac874","type":"mqtt out","z":"750f717a.6879a8","name":"","topic":"drone/moveto","qos":"","retain":"","broker":"3e7c6df.4bd9f92","x":960,"y":240,"wires":[]},{"id":"c039a459.7000a8","type":"json","z":"750f717a.6879a8","name":"","property":"payload","action":"","pretty":false,"x":450,"y":280,"wires":[["a886ad02.a098d"]]},{"id":"d10f271.3357dd8","type":"comment","z":"750f717a.6879a8","name":"Moveteller!!","info":"fout in de moveteller kan voor problemen zorgen\n(naar verkeerde coo vliegen -> opvangen met collision)","x":330,"y":40,"wires":[]},{"id":"37cafee1.f841c2","type":"switch","z":"750f717a.6879a8","name":"scanning?","property":"scanning","propertyType":"flow","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":290,"y":280,"wires":[["c039a459.7000a8"]]},{"id":"beed125d.469ee8","type":"switch","z":"750f717a.6879a8","name":"","property":"scanning","propertyType":"flow","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":790,"y":280,"wires":[["6337c49b.eac874"],["52838588.96d77c"]]},{"id":"52838588.96d77c","type":"mqtt out","z":"750f717a.6879a8","name":"","topic":"drone/scanner","qos":"1","retain":"","broker":"3e7c6df.4bd9f92","x":960,"y":320,"wires":[]},{"id":"549356f8.d06a7","type":"comment","z":"750f717a.6879a8","name":"","info":"Eerst moet hij de juiste scangegevens doorsturen naar de drone\nEenmaal gescant, moeten de juiste gegevens in de databank worden opgeslaan (API endpoint)","x":220,"y":340,"wires":[]},{"id":"3408fd99.77c03a","type":"debug","z":"750f717a.6879a8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":490,"y":400,"wires":[]},{"id":"f4706ab3.451c7","type":"change","z":"750f717a.6879a8","name":"","rules":[{"t":"set","p":"destination","pt":"msg","to":"destination","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":440,"wires":[["63b6709.44b3e9","7f679e23.ce4968"]]},{"id":"8f9e4c7f.af0b2","type":"change","z":"750f717a.6879a8","name":"","rules":[{"t":"set","p":"moveteller","pt":"msg","to":"moveteller","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":480,"wires":[["d7f60e11.0072d"]]},{"id":"efa301c0.084df8","type":"change","z":"750f717a.6879a8","name":"","rules":[{"t":"set","p":"stop","pt":"msg","to":"stop","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":810,"y":520,"wires":[["3b36f547.c62ea2"]]},{"id":"5a6bc7b5.a63e6","type":"change","z":"750f717a.6879a8","name":"","rules":[{"t":"set","p":"waypoints","pt":"msg","to":"waypoints","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":560,"wires":[["6a1050f9.ed40b8"]]},{"id":"c992eb78.1a765","type":"change","z":"750f717a.6879a8","name":"","rules":[{"t":"set","p":"diffX","pt":"msg","to":"diffX","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":810,"y":600,"wires":[["ca1bc6c6.26d078"]]},{"id":"63b6709.44b3e9","type":"debug","z":"750f717a.6879a8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1070,"y":400,"wires":[]},{"id":"7f679e23.ce4968","type":"debug","z":"750f717a.6879a8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"destination","targetType":"msg","x":1080,"y":440,"wires":[]},{"id":"d7f60e11.0072d","type":"debug","z":"750f717a.6879a8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"moveteller","targetType":"msg","x":1080,"y":480,"wires":[]},{"id":"3b36f547.c62ea2","type":"debug","z":"750f717a.6879a8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"stop","targetType":"msg","x":1060,"y":520,"wires":[]},{"id":"6a1050f9.ed40b8","type":"debug","z":"750f717a.6879a8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"waypoints","targetType":"msg","x":1080,"y":560,"wires":[]},{"id":"ca1bc6c6.26d078","type":"debug","z":"750f717a.6879a8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"diffX","targetType":"msg","x":1060,"y":600,"wires":[]},{"id":"74f7a9cd.d16ba","type":"change","z":"750f717a.6879a8","name":"","rules":[{"t":"set","p":"diffY","pt":"msg","to":"diffY","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":810,"y":640,"wires":[["876a9940.5d456"]]},{"id":"876a9940.5d456","type":"debug","z":"750f717a.6879a8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"diffY","targetType":"msg","x":1060,"y":640,"wires":[]},{"id":"430b31c8.22de","type":"change","z":"750f717a.6879a8","name":"","rules":[{"t":"set","p":"scan","pt":"msg","to":"scanning","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":820,"y":680,"wires":[["7cc741aa.3fff58"]]},{"id":"7cc741aa.3fff58","type":"debug","z":"750f717a.6879a8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"scan","targetType":"msg","x":1060,"y":680,"wires":[]},{"id":"6e6588e.29d0ef8","type":"mqtt in","z":"750f717a.6879a8","name":"","topic":"drone/scanned","qos":"1","datatype":"auto","broker":"3e7c6df.4bd9f92","x":100,"y":400,"wires":[["48f44dbb.52013c"]]},{"id":"48f44dbb.52013c","type":"function","z":"750f717a.6879a8","name":"next destination","func":"var moveteller = flow.get('moveteller');\nvar stop = flow.get('stop');\n\nif(moveteller < flow.get('waypoints').waypoints.length) {\n    msg.payload = flow.get('waypoints').waypoints[moveteller++];\n    flow.set('destination',msg.payload);\n}\nelse {\n    //positie om terug te keren\n    moveteller -= 2;\n    stop = true;\n}\n\nflow.set('moveteller', moveteller);\nflow.set('stop', stop);\nflow.set('scanning', false);\n\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":400,"wires":[["3408fd99.77c03a"]]},{"id":"3e7c6df.4bd9f92","type":"mqtt-broker","z":"","name":"local mosquitto","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""}]